<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>矩阵计算器</title>
    <link rel="stylesheet" href="/static/style.css">
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>
<body>
    <div class="container">
        <h1>在线矩阵计算器</h1>

        {% if error %}
        <div class="error">{{ error|safe }}</div>
        {% endif %}

        <form id="matrixForm" method="post">
            <div class="input-group">
                <label>行数(m): <input type="number" name="rows" min="1" value="{{ request.form.rows or 2 }}" required></label>
                <label>列数(n): <input type="number" name="cols" min="1" value="{{ request.form.cols or 2 }}" required></label>
                <button type="button" onclick="createMatrixInputs()">生成矩阵输入</button>
            </div>

            <div id="matrixInput"></div>

            <button type="submit">计算</button>
        </form>

        {% if results %}
        <div class="results">
            <h2>计算结果</h2>

            <div class="result-section">
                <h3>原始矩阵</h3>
                <div class="math-display">\[ {{ results.original }} \]</div>
            </div>

            <div class="result-section">
                <h3>行简化阶梯形(RREF)</h3>
                <div class="math-display">\[ {{ results.rref }} \]</div>
            </div>

            <div class="result-section">
                <h3>矩阵秩</h3>
                <p>{{ results.rank }}</p>
            </div>

            {% if results.is_square %}
            <div class="result-section">
                <h3>行列式</h3>
                <!-- 去掉 latex 函数调用 -->
                <div class="math-display">\[ {{ results.det }} \]</div>
            </div>

            <div class="result-section">
                <h3>特征多项式</h3>
                <div class="math-display">\[ {{ results.charpoly }} = 0 \]</div>
            </div>

            {% if results.eigen %}
            <div class="result-section">
                <h3>特征值与特征向量</h3>
                {% for eigen in results.eigen %}
                <div class="eigen-group">
                    <p>特征值: \( {{ eigen.value }} \) (代数重数: {{ eigen.multiplicity }})</p>
                    {% for vec in eigen.vectors %}
                    <div class="math-display">特征向量: \( {{ vec }} \)</div>
                    {% endfor %}
                </div>
                {% endfor %}
            </div>
            {% elif results.eigen_error %}
            <div class="error">特征值计算错误: {{ results.eigen_error }}</div>
            {% endif %}

            {% else %}
            <p class="info">非方阵无法计算行列式和特征值</p>
            {% endif %}
        </div>
        {% endif %}
    </div>

    <script>
        function createMatrixInputs() {
            const m = parseInt(document.querySelector('input[name="rows"]').value);
            const n = parseInt(document.querySelector('input[name="cols"]').value);
            const container = document.getElementById('matrixInput');

            let html = '<table>';
            for (let i = 0; i < m; i++) {
                html += '<tr>';
                for (let j = 0; j < n; j++) {
                    html += `<td><input type="text" name="matrix[${i}][${j}]"
                              placeholder="0" value="{{ request.form.get('matrix[${i}][${j}]', '') }}"></td>`;
                }
                html += '</tr>';
            }
            html += '</table>';

            container.innerHTML = html;
        }

        // 初始加载时生成输入框
        document.addEventListener('DOMContentLoaded', createMatrixInputs);
    </script>
</body>
</html>